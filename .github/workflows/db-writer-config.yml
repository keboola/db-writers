name: Build and Test DB Writer Config
on:
  workflow_call:

env:
  APP_IMAGE: keboola/db-writer-config

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: |
            docker build --target lib-db-writer-config -t $APP_IMAGE .
      # upload image to artifact
      - name: Upload image to artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.APP_IMAGE }}
          path: ./
        
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install Compose
        uses: ndeloof/install-compose-action@v0.0.1
        with:
          version: latest
          legacy: true
      - name: Download image from artifact
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.APP_IMAGE }}
      - name: Docker version
        run: docker -v
      - name: Docker-compose version
        run: docker-compose -v
      - name: Test
        run: |
          docker-compose run --rm dev-db-writer-config composer ci