name: Build and Test DB Writer Adapter
on:
  workflow_call:
    inputs:
      dockerhub-user:
        type: string
        required: true
      dockerhub-token:
        type: string
        required: true

env:
  APP_IMAGE: keboola/db-writer-mysql

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Docker login'
        if: inputs.dockerhub-token
        run: docker login --username "${{ inputs.dockerhub-user }}" --password "${{ inputs.dockerhub-token }}"
      - name: Build and export
        run: |
          docker build --target app-db-writer-mysql -t ${APP_IMAGE} .
          docker save ${APP_IMAGE} -o /tmp/db-writer-mysql.tar
      - name: Upload image to artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-writer-mysql
          path: /tmp/db-writer-mysql.tar

  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        mysql: [ latest, 8, 5.7 ]
    steps:
      - uses: actions/checkout@v4
      - name: Install Compose
        uses: ndeloof/install-compose-action@v0.0.1
        with:
          version: latest
          legacy: true
      - name: Docker version
        run: docker -v
      - name: Docker-compose version
        run: docker-compose -v
      - name: Download image from artifact
        uses: actions/download-artifact@v4
        with:
          name: db-writer-mysql
          path: /tmp
      - name: Load image
        run: docker load -i /tmp/db-writer-mysql.tar
      - name: Test
        run: |
          export MYSQL_VERSION="${{ matrix.mysql }}"
          docker-compose run wait-mysql
          docker-compose run wait-mysql-ssl
          docker-compose run --rm app-db-writer-mysql composer ci